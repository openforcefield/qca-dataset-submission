#!/usr/bin/env python

import os
import json
import tarfile

import qcportal as ptl
from qcelemental.models import Molecule

def read_selected_torsions(input_json):
    """ Read data generated by select_torsions.py

    Returns
    -------
    selected_torsions: dict
        Dictionary for selected torsions, has this structure:
        {
            canonical_torsion_index1: {
                'initial_molecules': [ Molecule1a, Molecule1b, .. ],
                'atom_indices': [ (0,1,2,3) ],
                'attributes': {'canonical_explicit_hydrogen_smiles': .., 'canonical_isomeric_smiles': .., ..}
            },
            ..
        }
    """
    if input_json.endswith(".gz"):
        import gzip
        with gzip.open(input_json, 'r') as infile:
            selected_torsions = json.load(infile)
    else:
        with open(input_json) as infile:
            selected_torsions = json.load(infile)
    return selected_torsions

print("Reading selected_torsions...")
input_json = 'selected_torsions.json.gz'
selected_torsions = read_selected_torsions(input_json)

print(f"Found {len(selected_torsions)} torsions")

print("Initializing dataset...")
# client = ptl.FractalClient.from_file()
client = ptl.FractalClient("localhost:7777", verify=False)

# create a new dataset with specified name
ds = ptl.collections.TorsionDriveDataset("Pfizer discrepancy torsion dataset 1", client=client)

# create specification for this dataset
opt_spec = {
    "program": "geometric",
    "keywords": {
        "coordsys": "tric",
        "enforce": 0.1,
        "reset": True,
        "qccnv": True,
        "epsilon": 0.0,
    }
}
qc_spec = {"driver": "gradient", "method": "B3LYP-d3bj", "basis": "dzvp", "program": "psi4"}
ds.add_specification("default", opt_spec, qc_spec, description="Standard OpenFF torsiondrive specification.")

# add molecules
print(f"Adding {len(selected_torsions)} torsions")
i = 0
for index, torsion_data in selected_torsions.items():
    attributes = torsion_data['attributes']
    smiles = attributes['canonical_isomeric_smiles']
    torsion_atom_indices = torsion_data['atom_indices']
    grid_spacings = [15] * len(torsion_atom_indices)
    initial_molecules = torsion_data['initial_molecules']
    print(f'{i} : {smiles} torsion atoms {torsion_atom_indices}')
    ds.add_entry(index, initial_molecules, torsion_atom_indices, grid_spacings, energy_upper_limit=0.05, attributes=attributes)
    i += 1
print("Submitting tasks...")
comp = ds.compute("default", tag="openff", priority="normal")
print(comp)

print("Complete!")
